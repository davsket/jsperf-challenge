<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>JavaScript Performance Challenge</title>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.css">
	<style>
		.results{
			display: flex
		}
		.result-gist{
			flex: 1;
			margin-left: 1em;
			padding: 0.5em 1em;
		}
		.result-gist:first-child{
			margin-left: 0;
		}
		.token.lf:before{
			content: " "
		}
		.faster{
			background: #DDF5DD
		}
	</style>
</head>
<body>
	<h1>JavaScript Performance Challenge</h1>
	<p>Carga los gist de los scripts que van a competir:</p>
	<div id="scripts" class="scripts">
		<input type="url">
		<input type="url">
	</div>
	<div class="actions">
		
	<button id="match">Comparar!</button>
	<a href="#" class="add-script" id="add-script">agregar script</a>
	</div>
	<div id="results" class="results">
	</div>
	<template id="result-template">
		<div class="result-gist">
			<h3>{{=it.user}}</h3>
			<h4>{{=it.name}}</h4>
			<pre><code class="language-javascript">{{=it.content}}</code></pre>
			<div class="result-gist__time"></div>
		</div>
	</template>
	<script src="node_modules/benchmark/benchmark.js"></script>
	<script src="node_modules/jquery/dist/jquery.min.js"></script>
	<script src="node_modules/lodash/dist/lodash.min.js"></script>
	<script src="node_modules/dot/doT.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js"></script>
	<script>
	(function(){
		var byId = document.getElementById.bind( document ),
			urlScr1 = byId( 'script1' ),
			urlScr2 = byId( 'script2' ),
			results = byId( 'results' ),
			exposedScripts = [],
			resultTempl = doT.template(byId( 'result-template' ).innerHTML),
			urlsRegs = [
					/https?\:\/\/gist\.github\.com\/\w+\/(\w+)/,
					/https?:\/\/gist\.githubusercontent\.com\/\w+\/(\w+)\/raw\/\w+/,
					/https?:\/\/gist\.github.com\/(\w+)\.git/
				]

		$('#match').on('click', function(){
			getScripts()
		})
		$('#add-script').on('click', function(){
			$('<input type="url">').appendTo('#scripts')
			return false
		})
		
		function getScripts(){
			results.innerHTML = ''

			$.when.apply($, $('#scripts input').map( function( i, input ){ 
					return getGist( input.value ) 
				}) )
				.done( function(){
					var resultsStr = ''

					exposedScripts.length = 0

					for( gist of arguments ){
						exposeScript( gist )
					}

					for( script of exposedScripts ){
						console.log(script.gist, resultTempl( script.gist ))
						resultsStr += resultTempl( script.gist )
					}

					results.innerHTML = resultsStr
					Prism.highlightAll()

					matchScripts()
				})
		}

		function getGist( url ){
			return getGistData( getGistId( url ) )
		}


		function getGistId( url ){
			for( regexp of urlsRegs ){
				if( regexp.test( url ) ) 
					return url.match( regexp )[1] 
			}
			throw 'Invalid gist URL: ' + url
		}

		function getGistData( id ){
			var def = $.Deferred()
			$.get( 'https://api.github.com/gists/' + id )
				.done( function( gistData ){
					var gist = _.toArray( gistData.files )[0]

					def.resolve({
						user: gistData.owner.login,
						content: gist.content,
						name: gist.filename
					})
				})
				.fail(function( e ){ def.reject(e) })

			return def
		}

		function exposeScript( gist ){
			var main

			eval('main = (function(){ ' +
					gist.content + '; return main }())')

			exposedScripts.push({
				gist: gist,
				main: main,
				index: exposedScripts.length
			})
		}

		function matchScripts(){
			var suite = new Benchmark.Suite,
				$resultElems = $('.result-gist .result-gist__time')

			for( script of exposedScripts ){
				suite.add( script.index + '. ' + script.gist.user + ': ' + 
					script.gist.name, script.main )
			}

			suite.on('cycle', function(event) {
					$resultElems[event.target.id - 1].innerHTML = String(event.target)
				})
				.on('complete', function() {
					this.filter('fastest')
						.forEach( function( fast ){
							$resultElems[fast.id - 1]
								.parentNode
								.classList.add('faster')
						})
				})
				.run({ 'async': true })
		}
	}())
	</script>
</body>
</html>